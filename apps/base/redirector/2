apiVersion: v1
kind: Namespace
metadata:
  labels:
    istio.io/dataplane-mode: ambient
    pod-security.kubernetes.io/enforce: restricted
  name: redirector
---
apiVersion: v1
data:
  nginx.conf: |
    load_module modules/ngx_http_js_module.so;

    pid /tmp/nginx.pid;

    events {
      worker_connections 768;
    }

    http {
      access_log off;

      client_body_temp_path /tmp/client_temp;
      fastcgi_temp_path /tmp/fastcgi_temp;
      js_import redirect from /etc/nginx/redirect.js;
      proxy_temp_path /tmp/proxy_temp;
      scgi_temp_path /tmp/scgi_temp;
      uwsgi_temp_path /tmp/uwsgi_temp;

      include /etc/nginx/mime.types;
      default_type application/octet-stream;

      server { # Instagram
        listen 8080;
        server_name instagram.com www.instagram.com;

        add_header Referrer-Policy "no-referrer" always;
        return 307 https://imginn.com$request_uri;
      }

      server { # Medium
        listen 8080;
        server_name medium.com *.medium.com;

        add_header Referrer-Policy "no-referrer" always;
        return 307 https://scribe.rip$request_uri;
      }

      server { # Skimresources
        listen 8080;
        server_name go.skimresources.com;

        add_header Referrer-Policy "no-referrer" always;

        location / {
          js_content redirect.redirectToUrlParameter;
        }
      }

      server { # Twitter
        listen 8080;
        server_name twitter.com *.twitter.com;
        server_name x.com *.x.com;

        add_header Referrer-Policy "no-referrer" always;
        return 307 https://xcancel.com$request_uri;
      }

      server {
        listen 8080 default_server;
        server_name _;

        location /healthz {
          add_header Content-Type text/plain;
          return 200 "OK\n";
        }

        location / {
          return 404;
        }
      }
    }
  redirect.js: |
    function redirectToUrlParameter(r) {
      var url = r.args.url;
      if (url) {
        r.return(307, decodeURIComponent(url));
      } else {
        r.return(400);
      }
    }

    export default { redirectToUrlParameter };
kind: ConfigMap
metadata:
  name: redirector-nginx-895c5dk2h7
  namespace: redirector
---
apiVersion: v1
kind: Service
metadata:
  name: redirector
  namespace: redirector
spec:
  ipFamilies:
  - IPv4
  ipFamilyPolicy: SingleStack
  ports:
  - name: http
    port: 80
    protocol: TCP
    targetPort: http
  selector:
    app: redirector
  type: ClusterIP
---
apiVersion: apps/v1
kind: Deployment
metadata:
  annotations:
    reloader.stakater.com/auto: "true"
  name: redirector
  namespace: redirector
spec:
  replicas: 1
  revisionHistoryLimit: 0
  selector:
    matchLabels:
      app: redirector
  strategy:
    rollingUpdate:
      maxSurge: 1
      maxUnavailable: 0
    type: RollingUpdate
  template:
    metadata:
      labels:
        app: redirector
    spec:
      containers:
      - image: docker.io/nginxinc/nginx-unprivileged:1.29.5-alpine
        livenessProbe:
          failureThreshold: 3
          httpGet:
            path: /healthz
            port: http
            scheme: HTTP
          periodSeconds: 10
          successThreshold: 1
          timeoutSeconds: 1
        name: nginx
        ports:
        - containerPort: 8080
          name: http
          protocol: TCP
        readinessProbe:
          failureThreshold: 3
          httpGet:
            path: /healthz
            port: http
            scheme: HTTP
          periodSeconds: 10
          successThreshold: 1
          timeoutSeconds: 1
        resources: {}
        securityContext:
          allowPrivilegeEscalation: false
          capabilities:
            drop:
            - ALL
          readOnlyRootFilesystem: true
          runAsNonRoot: true
        volumeMounts:
        - mountPath: /etc/nginx/nginx.conf
          name: config
          subPath: nginx.conf
        - mountPath: /etc/nginx/redirect.js
          name: config
          subPath: redirect.js
        - mountPath: /tmp
          name: tmp
      imagePullSecrets:
      - name: docker-hub
      securityContext:
        seccompProfile:
          type: RuntimeDefault
      volumes:
      - emptyDir: {}
        name: cache
      - configMap:
          name: redirector-nginx-895c5dk2h7
        name: config
      - emptyDir:
          medium: Memory
          sizeLimit: 1Mi
        name: tmp
---
apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: instagram
  namespace: redirector
spec:
  dnsNames:
  - instagram.com
  - www.instagram.com
  duration: 168h
  issuerRef:
    kind: ClusterIssuer
    name: ownca
  renewBefore: 8h
  secretName: instagram-tls
---
apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: medium
  namespace: redirector
spec:
  dnsNames:
  - medium.com
  - www.medium.com
  duration: 168h
  issuerRef:
    kind: ClusterIssuer
    name: ownca
  renewBefore: 8h
  secretName: medium-tls
---
apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: skimresources
  namespace: redirector
spec:
  dnsNames:
  - go.skimresources.com
  duration: 168h
  issuerRef:
    kind: ClusterIssuer
    name: ownca
  renewBefore: 8h
  secretName: skimresources-tls
---
apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: twitter
  namespace: redirector
spec:
  dnsNames:
  - twitter.com
  - www.twitter.com
  - www.x.com
  - x.com
  duration: 168h
  issuerRef:
    kind: ClusterIssuer
    name: ownca
  renewBefore: 8h
  secretName: twitter-tls
---
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: https-redirect
  namespace: redirector
spec:
  hostnames:
  - go.skimresources.com
  - instagram.com
  - medium.com
  - twitter.com
  - www.instagram.com
  - www.medium.com
  - www.twitter.com
  - www.x.com
  - x.com
  parentRefs:
  - kind: Gateway
    name: traefik-gateway
    namespace: traefik
    sectionName: web
  rules:
  - filters:
    - requestRedirect:
        scheme: https
        statusCode: 301
      type: RequestRedirect
---
apiVersion: isindir.github.com/v1alpha3
kind: SopsSecret
metadata:
  name: redirector-docker
  namespace: redirector
sops:
  age:
  - enc: |
      -----BEGIN AGE ENCRYPTED FILE-----
      YWdlLWVuY3J5cHRpb24ub3JnL3YxCi0+IFgyNTUxOSA4TXNmMHN0dUk5WjlzZjRO
      YmEvZTdTbU5BOVhmaFRLQTVQNzg1R0FoWUdJCnBFUFVnV1RMTFdOWGQxTkNoa0d5
      dXRyY0dIUTE3L3RzcldHbjVqSmxaVEEKLS0tIEVGYkRSUFJWNGVHVjFRMlp5enA5
      SkpFRnM4M2VxWlI3MlYxckk4SWRtOUEKyqoqKinz+BdbQmPXHTu8LPHGfrqpyDQb
      HuqJeS9y9yt0WOcdcPSziUq+xJa2mJfEha3BWkaIsw7RzDYg7HC9OQ==
      -----END AGE ENCRYPTED FILE-----
    recipient: age1cfvwwcvy3qj55kswlwymnvpwuwjymrp7xnjeycxma6qtdzv979qqd3kwue
  encrypted_suffix: Templates
  lastmodified: "2026-02-20T02:08:23Z"
  mac: ENC[AES256_GCM,data:1+mwSojOLZ7OppsCkdnuiwoNWs8O+7BBQuneGldFGDb438dGy88tGkdQqVTeUxgxgr/xTM9qVU6VjWCeKazhycZuhmky3wQaWo/8Tgtjpc+MBn8uN/IwAkI+lFaS2bqGjUQAQV8dXCFoKkQrSjAij5Gl3K4CjPDGKjwpIIa5/Kw=,iv:PjS5Z9k2cmcqnEHy1jMh8FvMGatdDhblgoIkz9e/qLY=,tag:vbLcf8ZxASwREUxO/eNOdw==,type:str]
  version: 3.12.0
spec:
  secretTemplates:
  - name: ENC[AES256_GCM,data:9mhIC+40ruossQ==,iv:HnoZ29hrlG/uHy1i2AqAT+noMf7k5gdyS/LWJ0r3Idw=,tag:Y9LzZAq54yID/SdA/xj/Cg==,type:str]
    stringData:
      .dockerconfigjson: ENC[AES256_GCM,data:w8EHEkixXkgsZz8vnkujvcBmFnrDmOmkRIQHYI1eOM5rkJ2N4z0AdBMKceoaVmEYKXW7ls9Stq4N4oPBrLutHtw68c57q9vSZH0LJTeZOnIpYSk9t1H6RdlsFXINS7uVP+qnisGFpUPv3s8aBGGZMKeQhZzgaQxQIoOkR0i7x6ABBvexUl82QvZURIkV784HdvQg3PM=,iv:we6cLWJz0L9IrjkbbsLsWbm5E7NBpl7dl4SPCHz/GkY=,tag:MBDEhpOrEpHJhWoTMOog5w==,type:str]
    type: ENC[AES256_GCM,data:XvRDESwfxSkAAHIrmHzxRFJMJVLtUgx7GhNuVLDG,iv:0xuQ9eJYpJwBqOC0SnuTJQV5b12PXXWDhOYHMr7htjY=,tag:O/oqvEF1FCF79nVyXJoApA==,type:str]
---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: redirector
  namespace: redirector
spec:
  ingress:
  - from:
    - namespaceSelector:
        matchLabels:
          kubernetes.io/metadata.name: traefik
      podSelector:
        matchLabels:
          app.kubernetes.io/name: traefik
  podSelector:
    matchLabels:
      app: redirector
  policyTypes:
  - Ingress
---
apiVersion: traefik.io/v1alpha1
kind: IngressRoute
metadata:
  name: redirector-instagram
  namespace: redirector
spec:
  entryPoints:
  - websecure
  routes:
  - kind: Rule
    match: Host(`instagram.com`) || Host(`www.instagram.com`)
    middlewares:
    - name: ip-allowlist
    services:
    - name: redirector
      port: 80
  tls:
    secretName: instagram-tls
---
apiVersion: traefik.io/v1alpha1
kind: IngressRoute
metadata:
  name: redirector-medium
  namespace: redirector
spec:
  entryPoints:
  - websecure
  routes:
  - kind: Rule
    match: Host(`medium.com`) || Host(`www.medium.com`)
    middlewares:
    - name: ip-allowlist
    services:
    - name: redirector
      port: 80
  tls:
    secretName: medium-tls
---
apiVersion: traefik.io/v1alpha1
kind: IngressRoute
metadata:
  name: redirector-skimresources
  namespace: redirector
spec:
  entryPoints:
  - websecure
  routes:
  - kind: Rule
    match: Host(`go.skimresources.com`)
    middlewares:
    - name: ip-allowlist
    services:
    - name: redirector
      port: 80
  tls:
    secretName: skimresources-tls
---
apiVersion: traefik.io/v1alpha1
kind: IngressRoute
metadata:
  name: redirector-twitter
  namespace: redirector
spec:
  entryPoints:
  - websecure
  routes:
  - kind: Rule
    match: Host(`twitter.com`) || Host(`www.twitter.com`) || Host(`www.x.com`) ||
      Host(`x.com`)
    middlewares:
    - name: ip-allowlist
    services:
    - name: redirector
      port: 80
  tls:
    secretName: twitter-tls
---
apiVersion: traefik.io/v1alpha1
kind: Middleware
metadata:
  name: ip-allowlist
  namespace: redirector
spec:
  ipAllowList:
    sourceRange:
    - 192.168.1.2/31
    - 192.168.1.4/30
    - 192.168.1.8/29
    - 192.168.1.16/28
    - 192.168.1.32/27
    - 192.168.1.64/26
    - 192.168.1.128/25
    - 192.168.4.0/24
    - 2a0b:9401:8b:1::/64
    - 2a0b:9401:8b:4::/64
